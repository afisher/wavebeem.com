<!DOCTYPE html>
<html lang="en">
<head>


<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Brian Mock">
<meta name="description" content="How to make code generation for a compiler">
<meta name="theme-color" content="#e8fdf5">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@wavebeem">
<meta name="twitter:creator" content="@wavebeem">
<meta name="og:title" content="Compiler Code Generation">
<meta name="og:description" content="How to make code generation for a compiler">
<meta name="og:image" content="https://mockbrian.com/brian.png">

<title>Compiler Code Generation</title>

<link rel="stylesheet" media="screen" href="/tachyons.min.css?t=1563254458666645000">
<link rel="stylesheet" media="screen" href="/style.css?t=1563254458666645000">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  (function(host) {
    var ids = {
      "dev.mockbrian.com": "UA-52704502-2",
      "mockbrian.com": "UA-52704502-1",
    };
    if (host in ids) {
      ga("create", ids[host], "auto");
      ga("send", "pageview");
    }
  }(window.location.host));
</script>

</head>
<body class="flex flex-column min-vh-100 bg-washed-green lh-copy helvetica">

<div class="flex-auto">





<!-- Small nav -->
<div class="dn-ns">
  <nav class="f3 flex flex-column mb4 bb dark-pink bw1 b--black-10">
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit pv2 ph3 flex-auto hover-outline b" href="/">Brian Mock</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit pv2 ph3 flex-auto hover-outline" href="/">Home</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit pv2 ph3 flex-auto hover-outline" href="/blog">Blog</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit pv2 ph3 flex-auto hover-outline" href="/resume">Resume</a>
  </nav>
</div>

<!-- Big nav -->
<div class="dn db-ns">
  <nav class="f3 flex mb4 items-center bb dark-pink bw1 b--black-10">
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit b" href="/">Brian Mock</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit" href="/">Home</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit" href="/blog">Blog</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit" href="/resume">Resume</a>
  </nav>
</div>


<main class="ph4-ns ph3 center flex-auto lh-copy Content">
  <h1 class="ma0 f1-ns f2 lh-title">
    <a href="#">Compiler Code Generation</a>
  </h1>
  <p class="ma0 helvetica">December 19, 2016</p>

  <h2>What is code generation?</h2>

<p>Compilers and interpreters are basically big pipelines, transforming one type of data to into another, and finally either generating code or running a program.</p>

<p>At a very high level, the steps are:</p>

<ul>
<li>üìö Read the source code</li>
<li>üå≤ Parse the code into an abstract syntax tree (AST)</li>
<li>Ô∏èÔ∏è‚ö†Ô∏è <em>(optional)</em> Emit warnings based on the AST</li>
<li>üîç <em>(optional)</em> Typecheck the AST</li>
<li>üíª Generate code or run the program</li>
</ul>

<p>Technically the AST step is optional (PHP only recently started using an AST), but basically every language implementation uses this step.</p>

<p>Code generation is the final step in a compiler. The compiler generates code that produces the desired effect. Generated code might be JavaScript (compile-to-JS language), machine code (C compiler), JVM bytecode (Java compiler, Clojure compiler, etc).</p>

<h2>Code generation vs interpretation</h2>

<p>My <a href="/blog/2016/11/01/making-a-language/">previous blog post</a> about making a programming language covers making an interpreter. Interpreters are easy to make because all you have to do is write a program that has the right behavior, whereas with a compiler, you have to generate code in another language that happens to have the same behavior as your source language.</p>

<p>This means that the more different your input and output languages are, the harder it is to do the code generation. <a href="http://coffeescript.org/">CoffeeScript</a> is extremely similar to JavaScript, so it is able to produce a similar amount of JavaScript as CoffeeScript to achive its code generation. <a href="http://www.purescript.org/">PureScript</a> requires a <em>lot</em> more JavaScript code output to achieve the correct program, because it is a lot more different than JavaScript.</p>

<p>Compiling to JavaScript is a bit of a unique case though, compared to compiling to machine code or some kind of bytecode. JavaScript is actually intended as a language for programmers to program in, unlike, say, JVM bytecode. So JavaScript environments expect you to debug and inspect JavaScript code. Nobody really cares if the JVM bytecode from a compiler looks <em>weird</em>, but if you generate really weird looking code from a language that compiles to JavaScript, it can bother people when they&#39;re debugging. <a href="https://github.com/estools/escodegen">Source maps</a> can help with that problem, but it&#39;s only a partial debugging solution.</p>

<h2>An example pipeline from start to finish</h2>

<p>In the interest of time, I&#39;ll just be going over a high level view of the steps in transforming a simple language with just basic math through the entire compiler process, but ommitting any code.</p>

<h2>Step 0: The input</h2>

<p>This is just the text that would be in a code text file. Let&#39;s call it CoolScript‚Ñ¢.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kd">let</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nx">print</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">^</span> <span class="mi">3</span>
</code></pre></div>
<h2>Step 1: Tokenization</h2>

<p>This is the output from the tokenization substep of parsing. Note that not all parsing techniques have a tokenization step.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">[</span> <span class="c1">// line 1</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Let'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'let'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Var'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'x'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Eq'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'='</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Number'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'1'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Newline'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'\n'</span> <span class="p">},</span>

  <span class="c1">// line 2</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Let'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'let'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Var'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'y'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Eq'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'='</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Number'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'2'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Newline'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'\n'</span> <span class="p">},</span>

  <span class="c1">// line 3</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Print'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'print'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Var'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'x'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Op'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'+'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Var'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'y'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Op'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'^'</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Number'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'3'</span> <span class="p">}</span> <span class="p">]</span>
</code></pre></div>
<h2>Step 2: Parsing</h2>

<p>This is the step where either the source code or source tokens are converted into JSON data that can be easily processed by the rest of the compiler. Importantly, this takes a linear sequence of data (either text or tokens), and turns it into deep, nested data.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span> <span class="nl">type</span><span class="p">:</span> <span class="s1">'Program'</span><span class="p">,</span>
  <span class="nx">statements</span><span class="err">:</span>
   <span class="p">[</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Let'</span><span class="p">,</span>
       <span class="na">name</span><span class="p">:</span> <span class="s1">'x'</span><span class="p">,</span>
       <span class="na">value</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Number'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
     <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Let'</span><span class="p">,</span>
       <span class="na">name</span><span class="p">:</span> <span class="s1">'y'</span><span class="p">,</span>
       <span class="na">value</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Number'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">},</span>
     <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Print'</span><span class="p">,</span>
       <span class="na">value</span><span class="p">:</span>
        <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Add'</span><span class="p">,</span>
          <span class="na">left</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Var'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'x'</span> <span class="p">},</span>
          <span class="na">right</span><span class="p">:</span>
           <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Pow'</span><span class="p">,</span>
             <span class="na">left</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Var'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'y'</span> <span class="p">},</span>
             <span class="na">right</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'cool.Number'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></div>
<h2>Step 3: Translating to JS</h2>

<p>This step is translating from the source language AST (CoolScript) to the destination language AST (JavaScript). This is definitely the hardest part of the compiler.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span> <span class="nl">type</span><span class="p">:</span> <span class="s1">'Program'</span><span class="p">,</span>
  <span class="nx">body</span><span class="err">:</span>
   <span class="p">[</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'VariableDeclaration'</span><span class="p">,</span>
       <span class="na">declarations</span><span class="p">:</span>
        <span class="p">[</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'VariableDeclarator'</span><span class="p">,</span>
            <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Identifier'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'x'</span> <span class="p">},</span>
            <span class="na">init</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Literal'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">raw</span><span class="p">:</span> <span class="s1">'1'</span> <span class="p">}</span> <span class="p">}</span> <span class="p">],</span>
       <span class="na">kind</span><span class="p">:</span> <span class="s1">'var'</span> <span class="p">},</span>
     <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'VariableDeclaration'</span><span class="p">,</span>
       <span class="na">declarations</span><span class="p">:</span>
        <span class="p">[</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'VariableDeclarator'</span><span class="p">,</span>
            <span class="na">id</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Identifier'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'y'</span> <span class="p">},</span>
            <span class="na">init</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Literal'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">raw</span><span class="p">:</span> <span class="s1">'2'</span> <span class="p">}</span> <span class="p">}</span> <span class="p">],</span>
       <span class="na">kind</span><span class="p">:</span> <span class="s1">'var'</span> <span class="p">},</span>
     <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'ExpressionStatement'</span><span class="p">,</span>
       <span class="na">expression</span><span class="p">:</span>
        <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'CallExpression'</span><span class="p">,</span>
          <span class="na">callee</span><span class="p">:</span>
           <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'MemberExpression'</span><span class="p">,</span>
             <span class="na">computed</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
             <span class="na">object</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Identifier'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'console'</span> <span class="p">},</span>
             <span class="na">property</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Identifier'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'log'</span> <span class="p">}</span> <span class="p">},</span>
          <span class="na">arguments</span><span class="p">:</span>
           <span class="p">[</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'BinaryExpression'</span><span class="p">,</span>
               <span class="na">operator</span><span class="p">:</span> <span class="s1">'+'</span><span class="p">,</span>
               <span class="na">left</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Identifier'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'x'</span> <span class="p">},</span>
               <span class="na">right</span><span class="p">:</span>
                <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'CallExpression'</span><span class="p">,</span>
                  <span class="na">callee</span><span class="p">:</span>
                   <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'MemberExpression'</span><span class="p">,</span>
                     <span class="na">computed</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                     <span class="na">object</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Identifier'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Math'</span> <span class="p">},</span>
                     <span class="na">property</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Identifier'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'pow'</span> <span class="p">}</span> <span class="p">},</span>
                  <span class="na">arguments</span><span class="p">:</span>
                   <span class="p">[</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Identifier'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'y'</span> <span class="p">},</span>
                     <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'Literal'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">raw</span><span class="p">:</span> <span class="s1">'3'</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">],</span>
  <span class="na">sourceType</span><span class="p">:</span> <span class="s1">'script'</span> <span class="p">}</span>
</code></pre></div>
<h2>Step 4: Code generation</h2>

<p>For code generation the JS AST is turned into JS source code. Given the immense object from step 3, <a href="https://github.com/estools/escodegen">escodegen</a> can be used to get this next step essentially for free.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
</code></pre></div>
<h2>Wrapping up</h2>

<p>For now, actually coding the pipeline for the demonstration above will be left as an exercise for the reader. I can suggest using <a href="https://github.com/jneen/parsimmon">Parsimmon</a> as per my last blog post. The AST translation will require your own hard work, but escodegen can be used to turn the JS AST into JS code with ease.</p>


  <div class="helvetica f3 mv4">
    <a
      class="ba bw1 br2 dark-pink db pv2 ph3 hover-bg-white-40 no-underline"
      href="/blog"
    >
      &lsaquo; Read other posts
    </a>
  </div>
</main>

<script type="module">
  // I would prefer to generate links for my h2 and h3 elements at build time,
  // but I can't figure out a good way to make Jekyll do that, sadly
  function slug(text) {
    return text
      .trim()
      .toLowerCase()
      .replace(/\'/gi, "")
      .replace(/[^a-z0-9]/gi, "-")
      .replace(/-{2,}/g, "-")
      .replace(/^-+|-+$/gm, "")
      .substring(0, 64);
  }

  for (const h of document.querySelectorAll("h2, h3")) {
    h.id = h.id || slug(h.textContent);
    h.innerHTML = "<a href='#" + h.id + "'>" + h.innerHTML + "</a>";
  }
</script>


</div>

<footer class="black-70 tc helvetica ph3 pv3 bt bw1 b--black-10 f4">
  &copy; 2019 Brian Mock
</footer>


</body>
</html>
