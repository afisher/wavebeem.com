<!DOCTYPE html>
<html lang="en">
<head>


<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Brian Mock">
<meta name="description" content="An exploration of Babel's caveats">
<meta name="theme-color" content="#e8fdf5">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@wavebeem">
<meta name="twitter:creator" content="@wavebeem">
<meta name="og:title" content="The Leaning Tower of Babel">
<meta name="og:description" content="An exploration of Babel's caveats">
<meta name="og:image" content="https://mockbrian.com/brian.png">

<title>The Leaning Tower of Babel</title>

<link rel="stylesheet" media="screen" href="/tachyons.min.css?t=1563254458666645000">
<link rel="stylesheet" media="screen" href="/style.css?t=1563254458666645000">

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  (function(host) {
    var ids = {
      "dev.mockbrian.com": "UA-52704502-2",
      "mockbrian.com": "UA-52704502-1",
    };
    if (host in ids) {
      ga("create", ids[host], "auto");
      ga("send", "pageview");
    }
  }(window.location.host));
</script>

</head>
<body class="flex flex-column min-vh-100 bg-washed-green lh-copy helvetica">

<div class="flex-auto">





<!-- Small nav -->
<div class="dn-ns">
  <nav class="f3 flex flex-column mb4 bb dark-pink bw1 b--black-10">
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit pv2 ph3 flex-auto hover-outline b" href="/">Brian Mock</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit pv2 ph3 flex-auto hover-outline" href="/">Home</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit pv2 ph3 flex-auto hover-outline" href="/blog">Blog</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit pv2 ph3 flex-auto hover-outline" href="/resume">Resume</a>
  </nav>
</div>

<!-- Big nav -->
<div class="dn db-ns">
  <nav class="f3 flex mb4 items-center bb dark-pink bw1 b--black-10">
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit b" href="/">Brian Mock</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit" href="/">Home</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit" href="/blog">Blog</a>
    <a class="pa3 hover-bg-white-40 hover-bottomline link color-inherit" href="/resume">Resume</a>
  </nav>
</div>


<main class="ph4-ns ph3 center flex-auto lh-copy Content">
  <h1 class="ma0 f1-ns f2 lh-title">
    <a href="#">The Leaning Tower of Babel</a>
  </h1>
  <p class="ma0 helvetica">August 22, 2016</p>

  <h2>About Babel</h2>

<p><a href="https://babeljs.io/">Babel</a> is the most popular <a href="https://github.com/lukehoban/es6features#readme">ES6</a> (aka ES2015) compiler right now. It takes code written in ES6 and turns it into code that runs in any ES5 JavaScript engine. ES5 is the overwhelming standard in JavaScript engines right now, but that is ever-changing, as evidenced by the <a href="https://kangax.github.io/compat-table/es6/">ES6 compatibility table</a>.</p>

<p>Babel allows you to &quot;Use next generation JavaScript, today&quot;, but of course there are caveats. It involves an additional build step (ES6-to-ES5 compilation), a Babel configuration file, and many plugins. Depending on what tools you integrate with, you may need Babel in multiple places. The <a href="https://babeljs.io/docs/setup/">setup page</a> details many integrations.</p>

<h2>What is this post about?</h2>

<p>The purpose of this blog post is not to discuss the upfront costs (extra compilation step, extra dependencies, difficulty of configuration), but to discuss the <em>eventual</em> costs of using Babel. Like most abstractions, <a href="https://en.wikipedia.org/wiki/Leaky_abstraction">Babel leaks</a>. What I mean specifically is that Babel in many cases cannot (or chooses not to) 100% correctly produce the semantics of ES6 in the resulting ES5 code.</p>

<h2>Why so picky about semantics?</h2>

<p>We all know that <code>2 + 2 === 4</code>. What if at some point in the future <code>2 + 2 === 4.0001</code>? That&#39;s almost right. That kind of error would not be acceptable in a banking app where people&#39;s money is on the line. You might display numbers rounded to the nearest cent, but minor errors will compound over time and produce problems.</p>

<p>Babel&#39;s ES6 compatibility is like thatâ€”it&#39;s almost right. For many scenarios, it&#39;s correct enough that you won&#39;t observe anything weird. But imagine one day Babel fixes its semantics, or more likely, ES6 becomes so widely supported you drop Babel in favor of native ES6. If you do that, your application might suddenly have massive bugs! At this point, whatever application you wrote right now in 2016 is probably considered legacy, and you&#39;re working at a different job, so now the new hire is tasked with your big blob of Babel-dependent code to fix for ES6, or never stop using Babel!</p>

<h2>Many examples</h2>

<p><a href="http://www.ecma-international.org/ecma-262/6.0/">ES6 has a long and complicated spec</a>. Writing a JavaScript engine that completely adheres to the spec is a <em>lot</em> of work. Writing an ES6-to-ES5 compiler that produces small output and adheres to the ES6 spec is practically impossible. I am only outlining the examples that I have seen or that others have pointed out to me.</p>

<h2>Arrow function new</h2>

<p>One of the most exciting features of ES6 is the arrow function. Essentially, <code>(x, y) =&gt; x + y</code> is like <code>function(x, y) { return x + y; }</code>, but there&#39;s a lot more nuance than that. One thing about arrow functions is that it&#39;s an <em>error</em> to call <code>new</code> on one. So this code snippet should throw an error in a compliant ES6 engine.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">Person</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">setName</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">amina</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">();</span>
<span class="nx">amina</span><span class="p">.</span><span class="nx">setName</span><span class="p">(</span><span class="s1">'Amina'</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">amina</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</code></pre></div>
<p>Babel compromises and just emits a regular function here, so the code works without errors.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s1">'use strict'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">Person</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">Person</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kc">undefined</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">setName</span><span class="p">:</span> <span class="kd">function</span> <span class="nx">setName</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">amina</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">();</span>
<span class="nx">amina</span><span class="p">.</span><span class="nx">setName</span><span class="p">(</span><span class="s1">'Amina'</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">amina</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</code></pre></div>
<p>Admittedly, Babel at least transforms direct use of <code>this</code> inside the arrow function into <code>undefined</code> now, so errors should be frequently caught sooner.</p>

<p>I noticed this error when I was using Mithril which calls user supplied functions using <code>new</code>, without making this clear in its documentation.</p>

<h2>Sloppy arguments</h2>

<p>ES6 arrow functions do not get <code>arguments</code> or <code>this</code> variables, but since Babel compiles to plain ES5 functions, it has to do some tricks to fix this. Unfortunately you can break this right now.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">global</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">window</span><span class="p">;</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">arguments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">arguments</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">());</span>
</code></pre></div>
<p>That should print <code>2</code>, but in Babel it references an undeclared variable.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s2">"use strict"</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">_arguments</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">global</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">window</span><span class="p">;</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">arguments</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">_arguments</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">());</span>
</code></pre></div>
<h2>Symbols</h2>

<p>ES6 symbols are a fairly complicated feature that really can&#39;t be compiled easily. Unfortunately, Babel ships with two different Symbols compilation modes, both with large caveats. Technically the &quot;library&quot; portions of ES6 are covered by the <a href="https://github.com/zloirock/core-js">core-js</a> project, but Babel encourages you to use it.</p>

<h2>Global Symbols</h2>

<p>The first polyfill route for symbols is to put all symbol keys as properties on <code>Object.prototype</code>, meaning that a seemingly harmless loop like this actually creates a massive memory leak.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">999999</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">Symbol</span><span class="p">()</span>
</code></pre></div>
<p>This polyfill technique creates a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Enumerability_and_ownership_of_properties">non-enumerable</a> property on <code>Object.prototype</code> every time you create a new symbol, which leads to incorrect ownership semantics, in addition to the memory leak.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">s1</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">s2</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">();</span>
<span class="nx">s1</span> <span class="k">in</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="c1">// true, but shouldn't be</span>
<span class="nx">s2</span> <span class="k">in</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span> <span class="c1">// true, but shouldn't be</span>
<span class="nx">s1</span> <span class="k">in</span> <span class="p">{};</span>               <span class="c1">// true, but shouldn't be</span>
<span class="nx">s2</span> <span class="k">in</span> <span class="p">{};</span>               <span class="c1">// true, but shouldn't be</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">({</span><span class="na">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">});</span>    <span class="c1">// ["a"], which is correct</span>
</code></pre></div>
<h2>Funny keys</h2>

<p>The other option is just to put the &quot;symbol&quot; keys into an object using a funny name that looks like gibberish. This clever hack is done by producing an object with a funny <code>toString</code> method, since objects are converted via <code>toString</code> automatically when used as keys to other objects. The implementation could look something like this:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">Symbol</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">tag</span> <span class="o">=</span> <span class="nx">tag</span> <span class="o">||</span> <span class="s2">""</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s2">"#Symbol("</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">+</span> <span class="s2">")#"</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">{</span><span class="na">toString</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">str</span><span class="p">;</span> <span class="p">}};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">Symbol</span><span class="p">(</span><span class="s2">"nice"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">o</span><span class="p">[</span><span class="nx">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// {"#Symbol(nice)#0": 1}</span>
</code></pre></div>
<p>This hack is simple and won&#39;t leak memory, but obviously it can cause problems with anything trying to enumerate the keys in an object, such as <code>Object.keys</code> or a <code>for (k in obj)</code> loop.</p>

<h2>Weird typeof</h2>

<p>The operator <code>typeof</code> is not extensible in ES5, so that also means that any use of <code>typeof</code> has to be converted into something more complicated so the new type <code>&quot;symbol&quot;</code> can be returned. This is how Babel currently handles it:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// typeof foo === "symbol" becomes...</span>

<span class="p">(</span><span class="k">typeof</span> <span class="nx">foo</span> <span class="o">===</span> <span class="s2">"undefined"</span> <span class="p">?</span> <span class="s2">"undefined"</span> <span class="p">:</span> <span class="nx">_typeof</span><span class="p">(</span><span class="nx">foo</span><span class="p">))</span> <span class="o">===</span> <span class="s2">"symbol"</span><span class="p">;</span>
</code></pre></div>
<h2>Generators / async+await</h2>

<p>Generators and <code>async</code> + <code>await</code> are very powerful features, but have to do with flow control in such a way that compiled output is extremely large and difficult to debug, plus generators still require a runtime library too. Look at how this simple example balloons in complexity.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span><span class="o">*</span> <span class="nx">nice</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">yield</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">yield</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">yield</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">x</span> <span class="nx">of</span> <span class="nx">nice</span><span class="p">())</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">asyncAdd</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getA</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getB</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Now remember that this compiled output needs a whole separate runtime library besides core-js which is called <a href="https://facebook.github.io/regenerator/">regenerator</a>.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s2">"use strict"</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">asyncAdd</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">_asyncToGenerator</span><span class="p">(</span><span class="nx">regeneratorRuntime</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="kd">function</span> <span class="nx">_callee</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">regeneratorRuntime</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="kd">function</span> <span class="nx">_callee$</span><span class="p">(</span>
      <span class="nx">_context2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">_context2</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">_context2</span><span class="p">.</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">case</span> <span class="mi">0</span><span class="err">:</span>
            <span class="nx">_context2</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">getA</span><span class="p">();</span>

          <span class="k">case</span> <span class="mi">2</span><span class="err">:</span>
            <span class="nx">x</span> <span class="o">=</span> <span class="nx">_context2</span><span class="p">.</span><span class="nx">sent</span><span class="p">;</span>
            <span class="nx">_context2</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">getB</span><span class="p">();</span>

          <span class="k">case</span> <span class="mi">5</span><span class="err">:</span>
            <span class="nx">y</span> <span class="o">=</span> <span class="nx">_context2</span><span class="p">.</span><span class="nx">sent</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">_context2</span><span class="p">.</span><span class="nx">abrupt</span><span class="p">(</span><span class="s2">"return"</span><span class="p">,</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">);</span>

          <span class="k">case</span> <span class="mi">7</span><span class="err">:</span>
          <span class="k">case</span> <span class="s2">"end"</span><span class="err">:</span>
            <span class="k">return</span> <span class="nx">_context2</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="nx">_callee</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}));</span>

  <span class="k">return</span> <span class="kd">function</span> <span class="nx">asyncAdd</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}();</span>

<span class="kd">function</span> <span class="nx">_asyncToGenerator</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gen</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">function</span> <span class="nx">step</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nx">gen</span><span class="p">[</span><span class="nx">key</span><span class="p">](</span><span class="nx">arg</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">step</span><span class="p">(</span><span class="s2">"next"</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
          <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">step</span><span class="p">(</span><span class="s2">"throw"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">step</span><span class="p">(</span><span class="s2">"next"</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_marked</span> <span class="o">=</span> <span class="p">[</span><span class="nx">nice</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">regeneratorRuntime</span><span class="p">.</span><span class="nx">mark</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">nice</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">regeneratorRuntime</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="kd">function</span> <span class="nx">nice$</span><span class="p">(</span><span class="nx">_context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="nx">_context</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">_context</span><span class="p">.</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
          <span class="nx">_context</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
          <span class="nx">_context</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
          <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

        <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
          <span class="nx">_context</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
          <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

        <span class="k">case</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">case</span> <span class="s2">"end"</span><span class="p">:</span>
          <span class="k">return</span> <span class="nx">_context</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="nx">_marked</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_iteratorNormalCompletion</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">_didIteratorError</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">_iteratorError</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span>
    <span class="kd">var</span> <span class="nx">_iterator</span> <span class="o">=</span> <span class="nx">nice</span><span class="p">()[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">](),</span> <span class="nx">_step</span><span class="p">;</span>
    <span class="o">!</span><span class="p">(</span><span class="nx">_iteratorNormalCompletion</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_step</span> <span class="o">=</span> <span class="nx">_iterator</span><span class="p">.</span><span class="nx">next</span><span class="p">()).</span><span class="nx">done</span><span class="p">);</span>
    <span class="nx">_iteratorNormalCompletion</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">_step</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_didIteratorError</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">_iteratorError</span> <span class="o">=</span> <span class="nx">err</span><span class="p">;</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_iteratorNormalCompletion</span> <span class="o">&amp;&amp;</span> <span class="nx">_iterator</span><span class="p">.</span><span class="k">return</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_iterator</span><span class="p">.</span><span class="k">return</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_didIteratorError</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nx">_iteratorError</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2>Default arguments</h2>

<p>ES6 default arguments are not scoped properly in Babel. This example should throw an exception when calling <code>f</code>:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="o">=</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">());</span>
</code></pre></div>
<p>But instead Babel produces code that simply returns <code>undefined</code>.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s2">"use strict"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">f</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">?</span> <span class="nx">x</span> <span class="p">:</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">());</span>
</code></pre></div>
<h2>ES6 modules</h2>

<p>Possibly one of the most anticipated features of ES6 is modules. Unfortunately, all that was really standardized with ES6 is the <em>syntax</em> of ES6 modules, and the semantics of module bindings. Any kind of interoperability with CommonJS was left unmentioned, and even the meaning of the module identifier was left <a href="https://whatwg.github.io/loader/">completely to another (unfinished) spec to decide</a>.</p>

<p>Because of all this, Babel has to make pragmatic decisions such that developers can use it <em>now</em>, and can continue to use the many CommonJS packaged JavaScript libraries available on <a href="https://www.npmjs.com/">npm</a>.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">foo</span> <span class="nx">from</span> <span class="s1">'bar'</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">foo</span> <span class="nx">from</span> <span class="s1">'bar'</span><span class="p">;</span>
</code></pre></div>
<p>Those two lines should have completely different semantics, but Babel makes them equivalent. This will probably break a lot of code that depends on Babel&#39;s specific compilation strategy for ES6 modules.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">export</span> <span class="p">{</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">};</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">};</span>
</code></pre></div>
<p>Confusingly, only the second export form is generating a JavaScript object, the first is merely performing multiple exports on the same line. Since Babel has to work with ES5 though, both forms generate objects at runtime, further confusing how ES6 modules actually work.</p>

<h2>Conclusion</h2>

<p>This is not to say that Babel, core-js, or regenerator are bad projects, or that you shouldn&#39;t use them. My point in writing this is that I don&#39;t see anyone talking about the issues with using these tools, and the issues with eventually <em>not</em> using these tools any more.</p>

<p>I don&#39;t use them in my personal projects mostly due to the added complexity. But this is your call, or your team&#39;s call.</p>


  <div class="helvetica f3 mv4">
    <a
      class="ba bw1 br2 dark-pink db pv2 ph3 hover-bg-white-40 no-underline"
      href="/blog"
    >
      &lsaquo; Read other posts
    </a>
  </div>
</main>

<script type="module">
  // I would prefer to generate links for my h2 and h3 elements at build time,
  // but I can't figure out a good way to make Jekyll do that, sadly
  function slug(text) {
    return text
      .trim()
      .toLowerCase()
      .replace(/\'/gi, "")
      .replace(/[^a-z0-9]/gi, "-")
      .replace(/-{2,}/g, "-")
      .replace(/^-+|-+$/gm, "")
      .substring(0, 64);
  }

  for (const h of document.querySelectorAll("h2, h3")) {
    h.id = h.id || slug(h.textContent);
    h.innerHTML = "<a href='#" + h.id + "'>" + h.innerHTML + "</a>";
  }
</script>


</div>

<footer class="black-70 tc helvetica ph3 pv3 bt bw1 b--black-10 f4">
  &copy; 2019 Brian Mock
</footer>


</body>
</html>
